// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum ProductCondition {
  BrandNew
  SecondHand
}

enum ProductAvailability {
  Available
  Sold
  Returned
}

enum InvoicePaymentType {
  Cash
  Credit
  Installment
}

enum InvoiceStatus {
  Pending
  PartiallyPaid
  Paid
  Cancelled
}

enum TransferStatus {
  Pending
  Approved
  Rejected
  Cancelled
  Completed
}

enum ReturnStatus {
  Open
  Processing
  Completed
  Rejected
}

enum ReturnResolution {
  Exchange
  Repair
}

enum ProductAuditAction {
  ProductCreated
  TransferRequested
  TransferReceived
  Sold
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]

  members     Member[]
  invitations Invitation[]

  role       String?
  banned     Boolean?  @default(false)
  banReason  String?
  banExpires DateTime?

  transfersRequested Transfer[] @relation("TransferRequestedBy")
  transfersReceived  Transfer[] @relation("TransferReceivedBy")

  accessoryTransfersRequested AccessoryTransfer[] @relation("AccessoryTransferRequestedBy")
  accessoryTransfersReceived  AccessoryTransfer[] @relation("AccessoryTransferReceivedBy")

  invoicesCreated Invoice[] @relation("InvoiceCreatedBy")

  returnsCreated Return[]

  productAuditLogs ProductAuditLog[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrganizationId String?

  impersonatedBy String?

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model ProductType {
  id        String         @id @default(cuid())
  name      String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  models    ProductModel[]

  @@unique([name])
  @@map("product_type")
}

model ProductModel {
  id            String      @id @default(cuid())
  name          String
  productTypeId String
  productType   ProductType @relation(fields: [productTypeId], references: [id], onDelete: Restrict)
  products      Product[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([productTypeId, name])
  @@index([productTypeId])
  @@map("product_model")
}

model Product {
  id             String              @id @default(cuid())
  productModelId String
  branchId       String?
  color          String
  ram            Int                 @default(0)
  storage        Int                 @default(0)
  imei           String              @unique @db.VarChar(15)
  condition      ProductCondition
  availability   ProductAvailability
  isDefective    Boolean             @default(false)
  defectNotes    String?
  status         String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  productModel ProductModel @relation(fields: [productModelId], references: [id], onDelete: Restrict)
  branch       Organization? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  transfers Transfer[]
  invoice   Invoice?
  invoiceItems InvoiceItem[]

  auditLogs ProductAuditLog[]

  returnItems ReturnProductItem[]
  replacementForReturnItems ReturnProductItem[] @relation("ReturnReplacementProduct")

  @@index([productModelId])
  @@index([branchId])
  @@map("product")
}

model ProductAuditLog {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  action ProductAuditAction

  actorUserId String
  actorUser   User @relation(fields: [actorUserId], references: [id], onDelete: Restrict)

  actorOrganizationId String?
  actorOrganization   Organization? @relation(fields: [actorOrganizationId], references: [id], onDelete: SetNull)

  fromBranchId String?
  toBranchId   String?

  transferId String?
  transfer   Transfer? @relation(fields: [transferId], references: [id], onDelete: SetNull)

  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  details Json?

  createdAt DateTime @default(now())

  @@index([productId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([actorOrganizationId, createdAt])
  @@map("product_audit_log")
}

model Organization {
  id          String       @id
  name        String
  slug        String
  logo        String?
  createdAt   DateTime
  metadata    String?
  members     Member[]
  invitations Invitation[]
  products    Product[]

  accessoryStocks AccessoryStock[]

  productAuditLogs ProductAuditLog[]

  transfersFrom Transfer[] @relation("TransferFromBranch")
  transfersTo   Transfer[] @relation("TransferToBranch")

  accessoryTransfersFrom AccessoryTransfer[] @relation("AccessoryTransferFromBranch")
  accessoryTransfersTo   AccessoryTransfer[] @relation("AccessoryTransferToBranch")

  invoices Invoice[]

  returns Return[]

  @@unique([slug])
  @@map("organization")
}

model Invoice {
  id          String             @id @default(cuid())
  productId   String             @unique
  branchId    String
  createdById String
  salePrice   Int
  paymentType InvoicePaymentType
  status      InvoiceStatus      @default(Pending)
  customerName  String?
  customerPhone String?
  notes       String?
  paidAt      DateTime?
  cancelledAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  product   Product       @relation(fields: [productId], references: [id], onDelete: Restrict)
  branch    Organization  @relation(fields: [branchId], references: [id], onDelete: Restrict)
  createdBy User          @relation("InvoiceCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)

  items InvoiceItem[]
  accessoryItems InvoiceAccessoryItem[]

  returns Return[]

  productAuditLogs ProductAuditLog[]

  @@index([branchId])
  @@index([createdById])
  @@index([status])
  @@index([createdAt])
  @@map("invoice")
}

model Return {
  id          String       @id @default(cuid())
  invoiceId   String
  branchId    String
  createdById String
  status      ReturnStatus @default(Open)
  reason      String?
  notes       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  invoice   Invoice       @relation(fields: [invoiceId], references: [id], onDelete: Restrict)
  branch    Organization  @relation(fields: [branchId], references: [id], onDelete: Restrict)
  createdBy User          @relation(fields: [createdById], references: [id], onDelete: Restrict)

  productItems   ReturnProductItem[]
  accessoryItems ReturnAccessoryItem[]

  @@index([invoiceId])
  @@index([branchId])
  @@index([createdById])
  @@index([status])
  @@index([createdAt])
  @@map("return")
}

model ReturnProductItem {
  id                   String           @id @default(cuid())
  returnId             String
  productId            String
  defectNotes          String?
  resolution           ReturnResolution
  replacementProductId String?
  createdAt            DateTime         @default(now())

  return Return  @relation(fields: [returnId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)
  replacementProduct Product? @relation("ReturnReplacementProduct", fields: [replacementProductId], references: [id], onDelete: SetNull)

  @@unique([returnId, productId])
  @@index([returnId])
  @@index([productId])
  @@index([replacementProductId])
  @@map("return_product_item")
}

model ReturnAccessoryItem {
  id          String           @id @default(cuid())
  returnId    String
  accessoryId String
  quantity    Int              @default(1)
  defectNotes String?
  resolution  ReturnResolution
  createdAt   DateTime         @default(now())

  return   Return   @relation(fields: [returnId], references: [id], onDelete: Cascade)
  accessory Accessory @relation(fields: [accessoryId], references: [id], onDelete: Restrict)

  @@index([returnId])
  @@index([accessoryId])
  @@map("return_accessory_item")
}

model InvoiceAccessoryItem {
  id          String   @id @default(cuid())
  invoiceId   String
  accessoryId String
  quantity    Int      @default(1)
  isFreebie   Boolean  @default(true)
  createdAt   DateTime @default(now())

  invoice   Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  accessory Accessory @relation(fields: [accessoryId], references: [id], onDelete: Restrict)

  @@unique([invoiceId, accessoryId])
  @@index([invoiceId])
  @@index([accessoryId])
  @@map("invoice_accessory_item")
}

model InvoiceItem {
  id        String   @id @default(cuid())
  invoiceId String
  productId String   @unique
  unitPrice Int      @default(0)
  discountAmount Int @default(0)
  netAmount  Int     @default(0)
  isFreebie  Boolean @default(false)
  createdAt  DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@index([invoiceId])
  @@index([productId])
  @@map("invoice_item")
}

model Transfer {
  id            String         @id @default(cuid())
  productId     String
  fromBranchId  String
  toBranchId    String
  requestedById String
  receivedById  String?
  reason        String
  notes         String?
  status        TransferStatus @default(Pending)
  receivedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  product     Product       @relation(fields: [productId], references: [id], onDelete: Restrict)
  fromBranch  Organization  @relation("TransferFromBranch", fields: [fromBranchId], references: [id], onDelete: Restrict)
  toBranch    Organization  @relation("TransferToBranch", fields: [toBranchId], references: [id], onDelete: Restrict)
  requestedBy User          @relation("TransferRequestedBy", fields: [requestedById], references: [id], onDelete: Restrict)
  receivedBy  User?         @relation("TransferReceivedBy", fields: [receivedById], references: [id], onDelete: SetNull)

  productAuditLogs ProductAuditLog[]

  @@index([productId])
  @@index([fromBranchId])
  @@index([toBranchId])
  @@index([requestedById])
  @@index([receivedById])
  @@map("transfer")
}

model Accessory {
  id   String @id @default(cuid())
  name String

  stocks    AccessoryStock[]
  transfers AccessoryTransfer[]
  invoiceItems InvoiceAccessoryItem[]

  returnItems ReturnAccessoryItem[]

  @@unique([name])
  @@map("accessory")
}

model AccessoryStock {
  id String @id @default(cuid())

  accessoryId String
  accessory   Accessory @relation(fields: [accessoryId], references: [id], onDelete: Restrict)

  branchId String
  branch   Organization @relation(fields: [branchId], references: [id], onDelete: Restrict)

  quantity Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accessoryId, branchId])
  @@index([branchId])
  @@index([accessoryId])
  @@map("accessory_stock")
}

model AccessoryTransfer {
  id String @id @default(cuid())

  accessoryId String
  accessory   Accessory @relation(fields: [accessoryId], references: [id], onDelete: Restrict)

  fromBranchId String
  fromBranch   Organization @relation("AccessoryTransferFromBranch", fields: [fromBranchId], references: [id], onDelete: Restrict)

  toBranchId String
  toBranch   Organization @relation("AccessoryTransferToBranch", fields: [toBranchId], references: [id], onDelete: Restrict)

  requestedById String
  requestedBy   User @relation("AccessoryTransferRequestedBy", fields: [requestedById], references: [id], onDelete: Restrict)

  receivedById String?
  receivedBy   User? @relation("AccessoryTransferReceivedBy", fields: [receivedById], references: [id], onDelete: SetNull)

  quantity Int
  reason   String
  notes    String?

  status     TransferStatus @default(Pending)
  receivedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accessoryId])
  @@index([fromBranchId])
  @@index([toBranchId])
  @@index([requestedById])
  @@index([receivedById])
  @@index([status])
  @@map("accessory_transfer")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member")
  createdAt      DateTime

  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}
